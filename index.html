<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üöó Teemo Parking Tracker ‚ù§Ô∏è</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: #f1f1f1;
    }
    h1 { 
      font-size: 1.5rem;
      text-align: center;
      margin-bottom: 20px;
      white-space: nowrap;
    }
    .card {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      margin-bottom: 20px;
    }
    .note { 
      color: #aaa; 
      font-size: 0.9rem; 
      text-align: center;
      margin-top: 20px;
      display: block;
    }
    .user-select {
      text-align: center;
      margin-top: 10px;
    }
    .user-select label {
      margin-right: 8px;
      font-size: 0.95rem;
      color: #ccc;
    }
    .user-select select {
      font-size: 1rem;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #2a2a2a;
      color: #f1f1f1;
    }

    .section-label {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    /* Floor buttons */
    .floor-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }

    .floor-buttons button {
      padding: 20px;
      border: none;
      border-radius: 12px;
      font-size: 1.3rem;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      opacity: 0.6;
    }
    .floor-buttons button.active {
      opacity: 1;
      box-shadow: 0 0 12px rgba(255,255,255,0.25);
      transform: scale(1.02);
    }
    .floor-buttons button .last-info {
      display: block;
      font-size: 0.85rem;
      font-weight: normal;
      margin-top: 6px;
      opacity: 0.9;
    }

    /* Spa-inspired muted palette */
    .floor-6 { background-color: #B55239; } /* Terracotta Red */
    .floor-5 { background-color: #D9822B; } /* Burnt Orange */
    .floor-4 { background-color: #D6A941; color:#000; text-shadow: 0 1px 2px rgba(0,0,0,0.3);} /* Ochre Yellow */
    .floor-3 { background-color: #6B8E23; } /* Moss Green */
    .floor-2 { background-color: #4C6A92; } /* Slate Blue */
    .floor-other { background-color: #5A5A5A; } /* Neutral Grey */

    .divider {
      border-top: 2px solid #333;
      margin: 15px 0;
    }

    /* Confirm Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }
    .modal-content h2 {
      margin: 0;
    }
    .modal-content input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #444;
      width: 100%;
      box-sizing: border-box;
      background: #2a2a2a;
      color: #f1f1f1;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .confirm-btn { background: #4C6A92; color: #fff; } /* Calm Slate Blue */
    .confirm-btn:hover { background: #3a5474; }
    .cancel-btn { background: #5A5A5A; color: #fff; } /* Neutral Grey */
    .cancel-btn:hover { background: #424242; }
  </style>
</head>
<body>
  <h1>üöó Teemo Parking Tracker ‚ù§Ô∏è</h1>

  <div class="card">
    <div class="section-label">Ëªä„ÅØ„Å©„ÅìÔºü</div>
    <div id="floor-buttons" class="floor-buttons">
      <button class="floor-6" data-label="6" onclick="openConfirm(6)">6</button>
      <button class="floor-5" data-label="5" onclick="openConfirm(5)">5</button>
      <button class="floor-4" data-label="4" onclick="openConfirm(4)">4</button>
      <button class="floor-3" data-label="3" onclick="openConfirm(3)">3</button>
      <button class="floor-2" data-label="2" onclick="openConfirm(2)">2</button>
      <div class="divider"></div>
      <button class="floor-other" data-label="Other" onclick="openConfirm('Other')">Other</button>
    </div>
  </div>

  <span id="lastUpdate" class="note">No updates yet.</span>

  <div class="user-select">
    <label for="userSelect">Updated by</label>
    <select id="userSelect">
      <option value="Tea">Tea</option>
      <option value="Mo">Mo</option>
    </select>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h2 id="confirmTitle">Confirm Floor</h2>
      <input type="text" id="confirmComment" placeholder="Optional comment">
      <div class="modal-buttons">
        <button class="confirm-btn" onclick="confirmSelection()">Confirm</button>
        <button class="cancel-btn" onclick="closeConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaV6PpoqxK0-t-Y2-V1lm9cdK0UlEuT5g",
      authDomain: "parking-tracker-a0f43.firebaseapp.com",
      projectId: "parking-tracker-a0f43",
      storageBucket: "parking-tracker-a0f43.appspot.com",
      messagingSenderId: "807627988635",
      appId: "1:807627988635:web:96653e2887c6b2778cb03e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const docRef = doc(db, "parking", "car");

    let pendingFloor = null;

    function timeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      if (diffMins < 1) return "just now";
      if (diffMins < 60) return `${diffMins} min ago`;
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours} hr${diffHours>1?'s':''} ago`;
      const diffDays = Math.floor(diffHours / 24);
      return `${diffDays} day${diffDays>1?'s':''} ago`;
    }

    const userSelect = document.getElementById("userSelect");
    const savedUser = localStorage.getItem("user");
    if (savedUser) userSelect.value = savedUser;
    userSelect.addEventListener("change", () => {
      localStorage.setItem("user", userSelect.value);
    });

    window.openConfirm = function(floor) {
      pendingFloor = floor;
      document.getElementById("confirmTitle").textContent = `Confirm Floor ${floor}`;
      document.getElementById("confirmComment").value = "";
      document.getElementById("confirmModal").style.display = "flex";
    }

    window.closeConfirm = function() {
      document.getElementById("confirmModal").style.display = "none";
    }

    window.confirmSelection = async function() {
      const comment = document.getElementById("confirmComment").value;
      const updatedBy = userSelect.value;
      const updatedAt = new Date();

      updateUI({ floor: pendingFloor, comment, updatedBy, updatedAt });
      document.getElementById("confirmModal").style.display = "none";

      await setDoc(docRef, {
        floor: pendingFloor,
        comment: comment,
        updatedBy: updatedBy,
        updatedAt: updatedAt
      });
    }

    function updateUI(data) {
      const lastUpdate = document.getElementById("lastUpdate");
      lastUpdate.textContent = `Last updated by ${data.updatedBy} ${timeAgo(data.updatedAt)}`;

      const buttons = document.querySelectorAll("#floor-buttons button");
      buttons.forEach(btn => {
        if (btn.dataset.label == data.floor) {
          btn.classList.add("active");
          btn.innerHTML = `${data.floor}<span class="last-info">${data.comment ? data.comment+" ‚Ä¢ " : ""}by ${data.updatedBy} ‚Ä¢ ${timeAgo(data.updatedAt)}</span>`;
        } else {
          btn.classList.remove("active");
          btn.textContent = btn.dataset.label;
        }
      });
    }

    onSnapshot(docRef, (snap) => {
      if (snap.exists()) {
        const data = snap.data();
        updateUI({
          floor: data.floor,
          comment: data.comment,
          updatedBy: data.updatedBy,
          updatedAt: new Date(data.updatedAt.seconds*1000)
        });
      }
    });
  </script>
</body>
</html>
