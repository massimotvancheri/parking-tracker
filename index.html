<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>üöó Parking Tracker</title>

  <meta name="theme-color" content="#d6cec3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <link rel="manifest" href="manifest.json">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #d6cec3;
      color: #3f3b37;
    }

    .app-container {
      height: 100%;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      padding: 10px;
    }

    .safe-top {
      padding-top: env(safe-area-inset-top);
      flex-shrink: 0;
    }

    .safe-bottom {
      padding-bottom: env(safe-area-inset-bottom);
      flex-shrink: 0;
    }

    h1 { 
      font-size: 1.5rem;
      text-align: center;
      margin: 10px 0 5px 0;
    }

    .card {
      background: #e6dfd6;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      width: 100%;
      box-sizing: border-box;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .section-label {
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 15px;
    }

    .floor-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .floor-buttons button {
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      opacity: 0.6;
    }

    .floor-buttons button.active {
      opacity: 1;
      box-shadow: 0 0 12px rgba(0,0,0,0.25);
      transform: scale(1.02);
    }

    .floor-buttons button .last-info {
      display: block;
      font-size: 0.8rem;
      font-weight: normal;
      margin-top: 4px;
      opacity: 0.9;
    }

    .floor-6 { background-color: #B55239; }
    .floor-5 { background-color: #D9822B; }
    .floor-4 { background-color: #D6A941; color: #000; }
    .floor-3 { background-color: #6B8E23; }
    .floor-2 { background-color: #4C6A92; }
    .floor-other { background-color: #5A5A5A; }

    .divider {
      border-top: 2px solid #b8b2ab;
      margin: 10px 0;
    }

    .bottom {
      text-align: center;
      margin-top: 8px;
    }

    .note { 
      color: #5c564f; 
      font-size: 0.9rem; 
      display: block;
      margin-bottom: 6px;
    }

    .user-select label {
      margin-right: 8px;
      font-size: 0.9rem;
      color: #555;
    }

    .user-select select {
      font-size: 16px;
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      background: #f0e8df;
      color: #3f3b37;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: #e6dfd6;
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-sizing: border-box;
    }

    .modal-content h2 {
      margin: 0;
      color: #3f3b37;
    }

    .modal-content input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      width: 100%;
      box-sizing: border-box;
      background: #f0e8df;
      color: #3f3b37;
      font-size: 16px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .confirm-btn { background: #8c8176; color: #f5f3ef; } 
    .confirm-btn:hover { background: #6f655d; }
    .cancel-btn { background: #d6cec3; color: #3f3b37; border: 1px solid #aaa; } 
    .cancel-btn:hover { background: #c5bcb2; }

    /* Setup screen */
    .setup-form {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 10px 0;
    }

    .setup-form label {
      font-weight: bold;
      font-size: 0.95rem;
      margin-bottom: -8px;
    }

    .setup-form input {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #aaa;
      background: #f0e8df;
      color: #3f3b37;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
    }

    .setup-form .hint {
      font-size: 0.8rem;
      color: #888;
      margin-top: -8px;
    }

    .setup-form button {
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      background: #8c8176;
      color: #f5f3ef;
      margin-top: 6px;
    }

    .setup-form button:hover {
      background: #6f655d;
    }

    .setup-msg {
      text-align: center;
      padding: 40px 20px;
      font-size: 1.1rem;
      color: #5c564f;
      line-height: 1.6;
    }

    .setup-msg code {
      background: #d6cec3;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    /* Settings gear */
    .settings-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      opacity: 0.5;
      padding: 4px;
    }
    .settings-btn:hover { opacity: 1; }

    .app-container { position: relative; }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="safe-top">
      <h1 id="appTitle">üöó Parking Tracker</h1>
      <button class="settings-btn" id="settingsBtn" style="display:none;" onclick="showSetup()">‚öôÔ∏è</button>
    </div>

    <div class="card">
      <div id="mainContent">
        <div class="loading">Loading...</div>
      </div>
    </div>

    <div class="bottom safe-bottom">
      <span id="lastUpdate" class="note" style="display:none;">No updates yet.</span>
      <div class="user-select" id="userSelectContainer" style="display:none;">
        <label for="userSelect">Updated by</label>
        <select id="userSelect"></select>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h2 id="confirmTitle">Confirm Floor</h2>
      <input type="text" id="confirmComment" placeholder="Optional comment">
      <div class="modal-buttons">
        <button class="confirm-btn" onclick="confirmSelection()">Confirm</button>
        <button class="cancel-btn" onclick="closeConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaV6PpoqxK0-t-Y2-V1lm9cdK0UlEuT5g",
      authDomain: "parking-tracker-a0f43.firebaseapp.com",
      projectId: "parking-tracker-a0f43",
      storageBucket: "parking-tracker-a0f43.appspot.com",
      messagingSenderId: "807627988635",
      appId: "1:807627988635:web:96653e2887c6b2778cb03e"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const params = new URLSearchParams(window.location.search);
    const groupId = params.get("id");
    const mainContent = document.getElementById("mainContent");

    if (!groupId) {
      document.getElementById("appTitle").textContent = "üöó Parking Tracker";
      mainContent.innerHTML = `
        <div class="setup-msg">
          <p>Welcome! Add <code>?id=yourgroup</code> to the URL to get started.</p>
          <p>Example:<br><code>?id=teemo</code></p>
        </div>
      `;
    } else {
      // References
      const settingsRef = doc(db, "settings", groupId);
      const parkingRef = doc(db, "parking", groupId);

      // Check if this group has been set up
      const settingsSnap = await getDoc(settingsRef);

      if (settingsSnap.exists()) {
        loadApp(settingsSnap.data());
      } else {
        showSetupScreen();
      }

      function showSetupScreen() {
        document.getElementById("appTitle").textContent = "üöó New Group Setup";
        document.getElementById("settingsBtn").style.display = "none";
        document.getElementById("lastUpdate").style.display = "none";
        document.getElementById("userSelectContainer").style.display = "none";

        mainContent.innerHTML = `
          <div class="setup-form">
            <label>App Title</label>
            <input type="text" id="setupTitle" placeholder="üöó Teemo Parking Tracker ‚ù§Ô∏è" value="${settingsSnap?.data()?.title || ''}">
            <div class="hint">Emojis welcome!</div>

            <label>User Names</label>
            <input type="text" id="setupUsers" placeholder="Tea, Mo" value="${settingsSnap?.data()?.users?.join(', ') || ''}">
            <div class="hint">Comma-separated names for the "Updated by" dropdown</div>

            <button onclick="saveSetup()">Save & Start</button>
          </div>
        `;
      }

      window.showSetup = function() {
        showSetupScreen();
      }

      window.saveSetup = async function() {
        const title = document.getElementById("setupTitle").value.trim();
        const usersRaw = document.getElementById("setupUsers").value.trim();

        if (!title || !usersRaw) {
          alert("Please fill in both fields.");
          return;
        }

        const users = usersRaw.split(",").map(u => u.trim()).filter(u => u);

        if (users.length < 1) {
          alert("Please enter at least one user name.");
          return;
        }

        const settings = { title, users };
        await setDoc(settingsRef, settings);
        loadApp(settings);
      }

      function loadApp(settings) {
        const { title, users } = settings;

        // Set title
        document.getElementById("appTitle").textContent = title;
        document.title = title;

        // Show settings gear
        document.getElementById("settingsBtn").style.display = "block";

        // Show bottom section
        document.getElementById("lastUpdate").style.display = "block";
        document.getElementById("userSelectContainer").style.display = "block";

        // Build user dropdown
        const userSelect = document.getElementById("userSelect");
        userSelect.innerHTML = "";
        users.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u;
          opt.textContent = u;
          userSelect.appendChild(opt);
        });

        const savedUser = localStorage.getItem(`user-${groupId}`);
        if (savedUser && users.includes(savedUser)) userSelect.value = savedUser;
        userSelect.addEventListener("change", () => {
          localStorage.setItem(`user-${groupId}`, userSelect.value);
        });

        // Build floor buttons
        mainContent.innerHTML = `
          <div class="section-label">Ëªä„ÅØ„Å©„ÅìÔºü</div>
          <div id="floor-buttons" class="floor-buttons">
            <button class="floor-6" data-label="6" onclick="openConfirm(6)">6</button>
            <button class="floor-5" data-label="5" onclick="openConfirm(5)">5</button>
            <button class="floor-4" data-label="4" onclick="openConfirm(4)">4</button>
            <button class="floor-3" data-label="3" onclick="openConfirm(3)">3</button>
            <button class="floor-2" data-label="2" onclick="openConfirm(2)">2</button>
            <div class="divider"></div>
            <button class="floor-other" data-label="Other" onclick="openConfirm('Other')">Other</button>
          </div>
        `;

        // Floor selection
        let pendingFloor = null;

        window.openConfirm = function(floor) {
          pendingFloor = floor;
          document.getElementById("confirmTitle").textContent = `Confirm Floor ${floor}`;
          document.getElementById("confirmComment").value = "";
          document.getElementById("confirmModal").style.display = "flex";
        }

        window.closeConfirm = function() {
          document.getElementById("confirmModal").style.display = "none";
        }

        window.confirmSelection = async function() {
          const comment = document.getElementById("confirmComment").value;
          const updatedBy = userSelect.value;
          const updatedAt = new Date();

          updateUI({ floor: pendingFloor, comment, updatedBy, updatedAt });
          document.getElementById("confirmModal").style.display = "none";

          await setDoc(parkingRef, {
            floor: pendingFloor,
            comment: comment,
            updatedBy: updatedBy,
            updatedAt: updatedAt
          });
        }

        function timeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          if (diffMins < 1) return "just now";
          if (diffMins < 60) return `${diffMins} min ago`;
          const diffHours = Math.floor(diffMins / 60);
          if (diffHours < 24) return `${diffHours} hr${diffHours > 1 ? 's' : ''} ago`;
          const diffDays = Math.floor(diffHours / 24);
          return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
        }

        function updateUI(data) {
          const lastUpdate = document.getElementById("lastUpdate");
          lastUpdate.textContent = `Last updated by ${data.updatedBy} ${timeAgo(data.updatedAt)}`;

          const buttons = document.querySelectorAll("#floor-buttons button");
          buttons.forEach(btn => {
            if (btn.dataset.label == data.floor) {
              btn.classList.add("active");
              btn.innerHTML = `Ëªä ‚Äì ${data.floor}<span class="last-info">${data.comment ? data.comment + " ‚Ä¢ " : ""}by ${data.updatedBy} ‚Ä¢ ${timeAgo(data.updatedAt)}</span>`;
            } else {
              btn.classList.remove("active");
              btn.textContent = btn.dataset.label;
            }
          });
        }

        onSnapshot(parkingRef, (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            updateUI({
              floor: data.floor,
              comment: data.comment,
              updatedBy: data.updatedBy,
              updatedAt: new Date(data.updatedAt.seconds * 1000)
            });
          }
        });
      }
    }
  </script>
</body>
</html>
